# 自転車トレーニング集計機能　要件書

## 1. プロジェクト概要

### 1.1 目的
既存のDelax100DaysWorkoutアプリに、自転車トレーニングの高度な集計・分析機能を追加し、FTP（Functional Threshold Power）、W/HR（ワット/心拍比）等の専門指標を用いてユーザーの成長を可視化する。

### 1.2 背景
- 現在のアプリは基本的なサイクリング記録（距離、時間、平均パワー）のみサポート
- FTP履歴管理、心拍数データ、Apple Health連携が不足
- プロジェクト概要書v2.0で要求されたSST分析機能、トレーニングカレンダーが未実装

## 2. 機能要件

### 2.1 必須機能（MUST）

#### 2.1.1 トレーニングカレンダー機能
- **カレンダー表示**: 月次・週次でトレーニング履歴を一覧表示
- **統合表示**: サイクリング、筋トレ、柔軟性、体重、FTP更新履歴を1つのカレンダーで管理
- **詳細確認**: 日付タップで当日の詳細データ（W/HR含む）をモーダル表示

#### 2.1.2 SST進捗ダッシュボード機能
- **FTP推移グラフ**: 時系列でのFTP変化をライン/バーチャートで表示
- **W/HR効率グラフ**: ワット対心拍比の推移を可視化
- **目標表示**: 20分最大パワー目標の自動計算・表示
- **パフォーマンス指標**: 現在のFTP、目標FTP、達成率の表示

#### 2.1.3 データロギング機能
- **FTP手動入力**: 新しいFTP値とメモの記録
- **体重手動入力**: 体重データの手動記録
- **Apple Health連携**: 
  - ワークアウトデータ（パワー、心拍数）の自動インポート
  - 体重データの自動同期
- **FTP自動更新提案**: 20分最大パワーに基づくFTP更新の提案

### 2.2 重要機能（SHOULD）

#### 2.2.1 高度な分析機能
- **パフォーマンストレンド**: 過去4週間のパフォーマンス向上率
- **一貫性スコア**: トレーニング実施の一貫性評価
- **W/HR効率分析**: 心拍効率の改善トレンド

#### 2.2.2 モチベーション機能
- **PR（Personal Record）検出**: 自動でのベスト記録認識
- **目標達成通知**: FTP向上、体重目標達成時の通知
- **励ましメッセージ**: パフォーマンス低下時の適切なフィードバック

### 2.3 オプション機能（COULD）

#### 2.3.1 エクスポート機能
- **CSV出力**: トレーニングデータのエクスポート
- **PDFレポート**: 月次・年次レポートの生成

#### 2.3.2 高度な予測機能
- **FTP予測**: 現在のトレーニングペースに基づく将来のFTP予測
- **最適化提案**: AIによるトレーニング強度・頻度の最適化提案

## 3. データ要件

### 3.1 新規データモデル

#### 3.1.1 FTPHistory
```swift
@Model
final class FTPHistory {
    var date: Date                    // 記録日
    var ftpValue: Int                 // FTP値（ワット）
    var measurementMethod: String     // 測定方法（20分テスト、ランプテスト等）
    var notes: String?                // メモ
    var isAutoCalculated: Bool        // 自動計算かどうか
}
```

#### 3.1.2 DailyMetric
```swift
@Model
final class DailyMetric {
    var date: Date                    // 記録日
    var weightKg: Double?             // 体重
    var restingHeartRate: Int?        // 安静時心拍数
    var maxHeartRate: Int?            // 最大心拍数
    var dataSource: String            // データソース（手動/AppleHealth）
}
```

### 3.2 既存モデル拡張

#### 3.2.1 CyclingDetail拡張
```swift
// 追加フィールド
var averageHeartRate: Int?       // 平均心拍数
var maxHeartRate: Int?          // 最大心拍数
var maxPower: Double?           // 最大パワー
var whrRatio: Double?           // W/HR比（自動計算）
```

## 4. UI/UX要件

### 4.1 トレーニングカレンダー
- **表示形式**: 月次グリッド表示（iOS標準カレンダーライク）
- **視覚的インジケーター**: 
  - サイクリング: 青いドット
  - 筋トレ: オレンジのドット
  - 柔軟性: 緑のドット
  - FTP更新: 星マーク
- **ナビゲーション**: 月次/週次表示の切り替えセグメント

### 4.2 SST進捗ダッシュボード
- **チャートライブラリ**: Swift Charts使用
- **レスポンシブ**: iPhone全サイズ対応
- **インタラクティブ**: チャート上のデータポイントタップで詳細表示

### 4.3 データ入力UI
- **クイック入力**: よく使う値のプリセット
- **検証**: 異常値（FTP 500W以上等）の警告
- **Apple Health同期**: 手動同期ボタンと自動同期設定

## 5. 性能要件

### 5.1 応答性能
- **チャート描画**: 1秒以内
- **カレンダー表示**: 0.5秒以内
- **Apple Health同期**: 5秒以内

### 5.2 データ量
- **FTP履歴**: 最大500件まで保持（約1年分）
- **日次メトリクス**: 最大365件まで保持（1年分）

## 6. 互換性要件

### 6.1 iOS要件
- **最小対応**: iOS 17.0+（SwiftData, Swift Charts要件）
- **Apple Health**: HealthKit使用のためiOS実機必須

### 6.2 既存機能との互換性
- **既存データ**: WorkoutRecord, CyclingDetailの既存データを破壊しない
- **後方互換**: 拡張フィールドはオプショナルとして実装

## 7. セキュリティ・プライバシー要件

### 7.1 健康データ保護
- **HealthKit**: 適切な権限要求とプライバシー表示
- **ローカル保存**: 健康データはデバイス内のみ保存
- **同意**: 明示的なユーザー同意のもとでのみデータアクセス

## 8. 成功基準

### 8.1 機能的成功基準
- [ ] 全てのMUST機能が実装され動作する
- [ ] Apple Health連携が正常に動作する
- [ ] FTP履歴が正確に追跡される
- [ ] カレンダー表示が1秒以内で完了する

### 8.2 ユーザー体験成功基準
- [ ] FTP向上が視覚的に理解できる
- [ ] W/HR効率の改善傾向が分かる
- [ ] 日々のトレーニング全体像が把握できる
- [ ] データ入力が直感的で高速

## 9. 制約事項

### 9.1 技術制約
- SwiftDataを使用したローカルデータ保存のみ
- Cloud同期は今回のスコープ外
- watchOS対応は今回のスコープ外

### 9.2 時間制約
- Phase 1-2（データ基盤）: 2024年9月末まで
- Phase 3-4（UI実装）: 2024年10月末まで

## 10. 受け入れ基準

各機能は以下の条件を満たすこと：
1. ユニットテストによる動作確認
2. iOS Simulatorでの動作確認
3. 実機でのApple Health連携確認
4. 既存機能への影響がないことの確認
5. プロジェクト仕様書v2.0への適合確認