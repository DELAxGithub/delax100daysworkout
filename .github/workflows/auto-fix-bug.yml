name: Auto Fix Bug with Approval

on:
  issues:
    types: [labeled]
  issue_comment:
    types: [created]

permissions:
  contents: write
  issues: write
  pull-requests: write

jobs:
  # Cost estimation when auto-fix-candidate label is added
  estimate-cost:
    if: |
      github.event_name == 'issues' && 
      github.event.action == 'labeled' && 
      contains(github.event.issue.labels.*.name, 'auto-fix-candidate') &&
      !contains(github.event.issue.labels.*.name, 'processing-auto-fix') &&
      !contains(github.event.issue.labels.*.name, 'cost-estimated')
    runs-on: ubuntu-latest
    concurrency:
      group: estimate-cost-${{ github.repository }}-issue-${{ github.event.issue.number }}
      cancel-in-progress: false
    
    steps:
      - name: Add processing label to prevent duplicates
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Add processing label to prevent duplicate runs
          gh api \
            --method POST \
            repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/labels \
            --raw-field labels='["processing-auto-fix"]' || echo "Label already exists"
          
      - name: Check for existing workflow
        id: check-duplicate
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if there's already a cost estimate comment
          EXISTING_COMMENT=$(gh api \
            repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments \
            --jq '[.[] | select(.user.login == "github-actions[bot]" and (.body | contains("è‡ªå‹•ä¿®æ­£ã®ã‚³ã‚¹ãƒˆè¦‹ç©ã‚‚ã‚Š")))] | length')
          
          if [ "$EXISTING_COMMENT" -gt 0 ]; then
            echo "duplicate=true" >> $GITHUB_OUTPUT
            echo "æ—¢ã«å‡¦ç†æ¸ˆã¿ã§ã™"
          else
            echo "duplicate=false" >> $GITHUB_OUTPUT
            echo "æ–°è¦å‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™"
          fi
          
      - name: Checkout repository
        if: steps.check-duplicate.outputs.duplicate == 'false'
        uses: actions/checkout@v4
        
      - name: Setup Python
        if: steps.check-duplicate.outputs.duplicate == 'false'
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        if: steps.check-duplicate.outputs.duplicate == 'false'
        run: |
          pip install pygithub
          pip install tiktoken
          
      - name: Estimate cost
        id: estimate
        if: steps.check-duplicate.outputs.duplicate == 'false'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python scripts/estimate_cost.py \
            --issue-number ${{ github.event.issue.number }} \
            --repo ${{ github.repository }} \
            --model claude-opus-4-20250514
            
      - name: Add cost limitation label if needed
        if: steps.estimate.outputs.can_afford == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Add cost-limit-reached label
          gh api \
            --method POST \
            repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/labels \
            --raw-field labels='["cost-limit-reached"]' || echo "Label already exists"
            
      - name: Mark cost estimation complete
        if: steps.check-duplicate.outputs.duplicate == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Add cost-estimated label to prevent duplicate estimates
          gh api \
            --method POST \
            repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/labels \
            --raw-field labels='["cost-estimated"]' || echo "Label already exists"
            
      - name: Remove processing label
        if: always() && steps.check-duplicate.outputs.duplicate == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Remove processing label after completion
          gh api \
            --method DELETE \
            repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/labels/processing-auto-fix || echo "Label not found"

  # Auto-fix execution after approval
  analyze-and-fix:
    if: |
      github.event_name == 'issue_comment' && 
      contains(github.event.issue.labels.*.name, 'auto-fix-candidate')
    
    runs-on: ubuntu-latest
    concurrency:
      group: analyze-and-fix-${{ github.repository }}-issue-${{ github.event.issue.number }}
      cancel-in-progress: true
    
    steps:
      - name: Check for approval
        id: check-approval
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Find the cost estimate comment from github-actions[bot]
          COST_COMMENT_ID=$(gh api \
            repos/${{ github.repository }}/issues/${{ github.event.issue.number }}/comments \
            --jq '.[] | select(.user.login == "github-actions[bot]" and (.body | contains("è‡ªå‹•ä¿®æ­£ã®ã‚³ã‚¹ãƒˆè¦‹ç©ã‚‚ã‚Š"))) | .id' | head -1)
          
          if [ -z "$COST_COMMENT_ID" ]; then
            echo "approved=false" >> $GITHUB_OUTPUT
            echo "ã‚³ã‚¹ãƒˆè¦‹ç©ã‚‚ã‚Šã‚³ãƒ¡ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
            exit 0
          fi
          
          # Get reactions on the cost estimate comment
          REACTIONS=$(gh api \
            repos/${{ github.repository }}/issues/comments/${COST_COMMENT_ID}/reactions \
            --jq '[.[] | select(.content == "+1")] | length')
          
          if [ "$REACTIONS" -gt 0 ]; then
            echo "approved=true" >> $GITHUB_OUTPUT
            echo "æ‰¿èªã‚’ç¢ºèªã—ã¾ã—ãŸ (Comment ID: $COST_COMMENT_ID, Reactions: $REACTIONS)"
          else
            echo "approved=false" >> $GITHUB_OUTPUT
            echo "æ‰¿èªãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ (Comment ID: $COST_COMMENT_ID, Reactions: $REACTIONS)"
          fi
          
      - name: Checkout repository
        if: steps.check-approval.outputs.approved == 'true'
        uses: actions/checkout@v4
        
      - name: Setup Python
        if: steps.check-approval.outputs.approved == 'true'
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install dependencies
        if: steps.check-approval.outputs.approved == 'true'
        run: |
          pip install anthropic
          pip install pygithub
          pip install pillow
          pip install requests
          
      - name: Update comment with processing status
        if: steps.check-approval.outputs.approved == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ github.event.issue.number }} \
            --body "ğŸ”„ æ‰¿èªã‚’ç¢ºèªã—ã¾ã—ãŸã€‚è‡ªå‹•ä¿®æ­£ã‚’é–‹å§‹ã—ã¾ã™..."
            
      - name: Check cost limit before analysis
        id: cost-check
        if: steps.check-approval.outputs.approved == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python scripts/cost_tracker.py \
            --repo ${{ github.repository }} \
            --action summary
            
      - name: Analyze issue
        id: analyze
        if: steps.check-approval.outputs.approved == 'true'
        env:
          CLAUDE_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python scripts/analyze_issue.py \
            --issue-number ${{ github.event.issue.number }} \
            --repo ${{ github.repository }}
            
      - name: Generate fix
        id: generate
        if: steps.check-approval.outputs.approved == 'true' && steps.analyze.outputs.can_auto_fix == 'true'
        env:
          CLAUDE_API_KEY: ${{ secrets.CLAUDE_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          python scripts/generate_fix.py \
            --issue-number ${{ github.event.issue.number }} \
            --repo ${{ github.repository }} \
            --analysis "${{ steps.analyze.outputs.analysis }}"
            
      - name: Create fix branch
        if: steps.generate.outputs.has_fix == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git checkout -b fix/issue-${{ github.event.issue.number }}
          
      - name: Apply fix
        if: steps.generate.outputs.has_fix == 'true'
        run: |
          python scripts/apply_fix.py \
            --fix-data "${{ steps.generate.outputs.fix_data }}"
            
      - name: Run Swift tests
        if: steps.generate.outputs.has_fix == 'true'
        run: |
          # macOSç’°å¢ƒã§ã¯ xcodebuild ã‚’ä½¿ç”¨
          # Ubuntuç’°å¢ƒã§ã¯ Swift Package Manager ã‚’ä½¿ç”¨ï¼ˆå°†æ¥çš„ãªå¯¾å¿œï¼‰
          echo "Tests would run here in macOS environment"
            
      - name: Commit changes
        if: steps.generate.outputs.has_fix == 'true'
        run: |
          git add -A
          git commit -m "Auto-fix: ${{ github.event.issue.title }}

          Fixes #${{ github.event.issue.number }}
          
          This fix was automatically generated by Claude AI."
          
      - name: Push branch
        if: steps.generate.outputs.has_fix == 'true'
        run: |
          git push origin fix/issue-${{ github.event.issue.number }}
            
      - name: Create PR
        id: create-pr
        if: steps.generate.outputs.has_fix == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_URL=$(gh pr create \
            --title "Auto-fix: ${{ github.event.issue.title }}" \
            --body "$(cat <<'EOF'
          ## è‡ªå‹•ä¿®æ­£
          
          ã“ã®PRã¯ Issue #${{ github.event.issue.number }} ã‚’è‡ªå‹•çš„ã«ä¿®æ­£ã—ã¾ã™ã€‚
          
          ### ä¿®æ­£å†…å®¹
          ${{ steps.generate.outputs.fix_summary }}
          
          ### å®‰å…¨æ€§ãƒã‚§ãƒƒã‚¯
          - å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«æ•°: ${{ steps.generate.outputs.changed_files_count }}
          - å¤‰æ›´è¡Œæ•°: ${{ steps.generate.outputs.changed_lines_count }}
          - ãƒªã‚¹ã‚¯ãƒ¬ãƒ™ãƒ«: ${{ steps.generate.outputs.risk_level }}
          
          ### ãƒ†ã‚¹ãƒˆçµæœ
          - [ ] ãƒ“ãƒ«ãƒ‰æˆåŠŸ
          - [ ] æ—¢å­˜ãƒ†ã‚¹ãƒˆãƒ‘ã‚¹
          - [ ] æ–°è¦ãƒ†ã‚¹ãƒˆè¿½åŠ ï¼ˆå¿…è¦ãªå ´åˆï¼‰
          
          ---
          ğŸ¤– ã“ã®PRã¯è‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ãŠé¡˜ã„ã—ã¾ã™ã€‚
          EOF
          )" \
            --label "auto-generated" \
            --assignee ${{ github.event.issue.user.login }})
          echo "pr_url=$PR_URL" >> $GITHUB_OUTPUT
          PR_NUMBER=$(echo "$PR_URL" | grep -o '[0-9]\+$')
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
            
      - name: Comment on issue
        if: always() && steps.check-approval.outputs.approved == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [ "${{ steps.generate.outputs.has_fix }}" == "true" ]; then
            gh issue comment ${{ github.event.issue.number }} \
              --body "ğŸ¤– è‡ªå‹•ä¿®æ­£ã‚’å®Œäº†ã—ã¾ã—ãŸã€‚[PR #${{ steps.create-pr.outputs.pr_number }}](${{ steps.create-pr.outputs.pr_url }}) ã‚’ã”ç¢ºèªãã ã•ã„ã€‚"
          elif [ "${{ steps.analyze.outputs.can_auto_fix }}" == "false" ]; then
            gh issue comment ${{ github.event.issue.number }} \
              --body "ğŸ¤– ã“ã®Issueã¯è‡ªå‹•ä¿®æ­£ã®å¯¾è±¡å¤–ã§ã™ã€‚ç†ç”±: ${{ steps.analyze.outputs.reason }}"
          else
            gh issue comment ${{ github.event.issue.number }} \
              --body "ğŸ¤– è‡ªå‹•ä¿®æ­£ã®å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚é–‹ç™ºè€…ã«ã‚ˆã‚‹å¯¾å¿œãŒå¿…è¦ã§ã™ã€‚"
          fi